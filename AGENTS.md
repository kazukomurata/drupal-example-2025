# AGENTS.md

このドキュメントは、本リポジトリでコーディングエージェント（Codex CLI 等）が作業するための実務ガイドです。短く、正確に、最小変更でタスクを完了する方針を徹底してください。

## 目的と対象
- 対象: 端末ベースのコーディングエージェント（人間の開発者にも有用）
- 目的: 期待される振る舞い、編集ルール、検証方法、Drupal 向けの注意点を明確化

## 作業スタイル（デフォルト）
- 簡潔・友好的・事実ベース。余計な前置きや冗長な説明は不要。
- タスクは「根本原因の修正」を優先。周辺の無関係な修正は避ける。
- 変更は小さく局所的に。既存の命名や構成に合わせる。
- 不明点や選択肢がある場合は、短く前提を確認してから実装。

## メッセージ作法（Codex CLI）
- ツール実行前のひとこと: 8–12語/1–2文で、直後に何をするかを端的に伝える。
- 計画の共有: 複数ステップになる場合のみ `update_plan` を使い、非自明なTODOを短文で列挙。常に1件だけ `in_progress`。
- 進捗の共有: 長い処理の前後に1–2文で要点のみ。
- 最終返答の体裁: 箇条書き中心で要点を整理。過度な装飾や引用は不要。

### 返答のスタイル（要点）
- 日本語で返答する。
- 見出しは必要なときのみ（1–3語、太字）。
- 箇条書きは「太字のキーワード: 端的な説明」。
- コマンド/パス/識別子はバッククォートで囲む（例: `docroot/modules/custom`）。
- ファイル参照はクリック可能な相対パス形式で、開始行番号付き（例: `docroot/index.php:1`）。

## ファイル編集とコマンド実行
- 変更は必ず `apply_patch` を使って行う（手動で貼り付けない）。
- 1回のパッチで関連変更をまとめる。無関係な修正は混ぜない。
- 大きなファイルの読み込みは 250 行以内に分割。`rg` を優先して検索。

### サンドボックス/承認
- 標準では「ワークスペース書き込み可」「ネットワーク制限あり」「on-request 承認」。
- ネットワークや外部書き込み、破壊的操作が必要な場合は、実行前に1文の理由とともに承認を求める。

## Drupal プロジェクト固有の指針
- ルート構成: ドキュメントルートは `docroot/`。Drupal Recommended Project 構成。
- Composer: 依存は `composer.json`/`composer.lock` に固定。無断で新規導入しない。
- カスタムコード配置:
  - モジュール: `docroot/modules/custom/<module_name>`
  - テーマ: `docroot/themes/custom/<theme_name>`
  - 既存の `phpstan.neon` と `phpcs.xml` は `docroot/modules/custom` のみを対象（テーマは対象外）。必要なら相談の上で見直し。
- 静的解析/整形:
  - PHP コーディング規約: PHPCS Drupal 標準（`phpcs.xml`）
  - 静的解析: PHPStan Level 5（`phpstan.neon`）
  - 可能なら変更前後で PHPCS/PHPStan を実行して逸脱を防ぐ。
- DDEV/Drush:
  - ローカル起動・DB関連は DDEV を利用（このドキュメントでは手順詳細は割愛）。
  - `drush` は `vendor` に同梱。コマンド実行は実行前に1文の理由とともに承認を求める。

## 検証コマンド例
- PHPCS: `ddev exec phpcs`（全体）または変更ファイルを指定して実行。
- PHPStan: `ddev exec phpstan analyse`（対象パスは `phpstan.neon` 参照）。
- PHPUnit: `ddev exec phpunit` （全体）または変更ファイルを指定して実行。
- Drush（任意）: `ddev drush cr`、`ddev drush status` など。

注: ネットワークが制限されている環境では追加インストールは避け、既存の `vendor/` を活用する。

## 禁則事項
- 無断の依存追加・削除、破壊的変更、リネーム乱用。
- 依頼範囲外の広範なリファクタリングや最適化。
- 著作権/ライセンスヘッダの追加（明示要求がある場合のみ）。
- 不要なインラインコメントや一文字変数（明示要求がある場合のみ許容）。

## 変更のまとめ方（提出物）
- 何を、なぜ、どう直したかを1–4項目の箇条書きで要約。
- 影響範囲/互換性/フォローアップがあれば簡潔に記載。
- 次のアクション（任意）: テスト実行、レビュー依頼、関連タスク提案など。

## 例: 短い作業フロー
1) 直前に実行する内容を1文で宣言。
2) 必要なファイルを 250 行以内で確認。
3) `apply_patch` で最小限の差分を作成。
4) 可能であれば `ddev exec phpcs` と `ddev exec phpstan analyse` で検証。
5) 最終返答で要点と次の一歩を簡潔に提示。

## 参考情報（リポジトリ直下）
- `composer.json:1`: Composer 設定
- `phpcs.xml:1`: PHPCS ルール（Drupal 標準）
- `phpstan.neon:1`: PHPStan 設定（Level 5）
- `docroot/`: Drupal ドキュメントルート

---

疑問点や前提の競合があれば、作業前に1–2文で前提確認を行ってください。
